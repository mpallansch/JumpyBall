<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Example Project</title>
        <meta charset="UTF-8">
        <meta id="viewport" name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scaleable=no, target-densitydpi=device-dpi">
        <style>
            canvas#myCanvas {
                display:block; 
                margin:0; 
                padding: 0;
                border:20px;
            }
        </style>
        <script type="text/javascript" src="phonegap.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script src="js/hammer.js"></script>
        <script type="text/javascript">
            app.initialize();
        </script>
        <script>
            window.onload = function()
            {
                document.addEventListener("deviceready", init(), false);
            };

            function init() {
                watch = navigator.accelerometer.watchAcceleration(accSuccess, accError, {frequency: 25});
                play();
            }
        </script>
    </head>
    <body id="body" style="padding:0; margin:0;">
        <canvas id="myCanvas"></canvas>
        <img id="restart" src="restart.png" alt="" hidden="hidden">
        <script>

            var canvas = document.getElementById("myCanvas");
            canvas.width = window.screen.availWidth;
            canvas.height = window.screen.availHeight;
            var ctx = canvas.getContext('2d');

            var xOffset = canvas.offsetLeft;
            var yOffset = canvas.offsetTop;

            width = canvas.width;
            height = canvas.height;
            if (width <= height) {
                var smallest = width;
            }
            else {
                var smallest = height;
            }
            thickness = smallest * (2 / 60);
            
            //first block must be the block the player starts on
            var level1blocks = new Array(new block(0, height - thickness, width, thickness), new block(-thickness, 0, thickness, height), new block(0, -thickness, width, thickness), new block(width, 0, thickness, height), new block(0, height * (2 / 3), width * (1 / 3), thickness), new block(width * (2 / 3), height * (2 / 3), width * (2 / 3), thickness), new block(0, height * (1 / 3), width * (1 / 6), thickness), new block(width / 2, height / 3, width / 2, thickness));
            var level2blocks = new Array(new block(0, height - thickness, width, thickness), new block(-thickness, 0, thickness, height), new block(0, -thickness, width, thickness), new block(width, 0, thickness, height), new block(0, height * (5 / 6), width * (1 / 6), thickness), new block(width * (5 / 6), height * (5 / 6), width * (1 / 6), thickness), new block(0, height / 2, width * (3 / 4), thickness), new block(width * (11 / 12), height / 2, width / 12, thickness), new block(0, height / 6, width / 6, thickness), new block(width / 3, height / 6, width / 3, thickness), new block(width * (5 / 6), height / 6, width / 6, thickness));
            var level3blocks = new Array(new block(0, height - thickness, width, thickness), new block(-thickness, 0, thickness, height), new block(0, -thickness, width, thickness), new block(width, 0, thickness, height), new block(width / 2, height / 6, thickness, height * (5 / 6)), new block(width / 6, height * (3 / 4), width * (2 / 3), thickness), new block(0, height / 3, width / 6, thickness), new block(width / 3, height * (7 / 12), width / 6, thickness));
            var level4blocks = new Array(new block(0, height - thickness, width, thickness), new block(-thickness, 0, thickness, height), new block(0, -thickness, width, thickness), new block(width, 0, thickness, height), new block(width * (5 / 12), height * (7 / 12), width / 6, thickness), new block(width / 20, 0, thickness, height / 6));
            var level5blocks = new Array(new block(0, height - thickness, width, thickness), new block(-thickness, 0, thickness, height), new block(0, -thickness, width, thickness), new block(width, 0, thickness, height), new block(width / 3, height / 3, thickness, height * (2 / 3)), new block(width / 2, height / 3, thickness, height * (2 / 3)), new block(width * (2 / 3), height / 3, thickness, height * (2 / 3)), new block(width / 6, height * (3 / 4), width / 6, thickness), new block(0, height / 2, width / 6, thickness));
            var level6blocks = new Array(new block(0, height - thickness, width, thickness), new block(-thickness, 0, thickness, height), new block(0, -thickness, width, thickness), new block(width, 0, thickness, height), new block(width / 2 - width / 12, height * 2 / 3, width / 6, thickness), new block(width * 2 / 3, height / 2, width / 6, thickness), new block(width / 2 - width / 12, height / 4, width / 6, thickness), new block(width / 12 - thickness, 0, thickness, height / 6));
            var level7blocks = new Array(new block(0, height - thickness, width, thickness), new block(-thickness, 0, thickness, height), new block(0, -thickness, width, thickness), new block(width, 0, thickness, height));
            var level8blocks = new Array(new block(0, height - thickness, width, thickness), new block(-thickness, 0, thickness, height), new block(0, -thickness, width, thickness), new block(width, 0, thickness, height));
            var level9blocks = new Array(new block(0, height - thickness, width, thickness), new block(-thickness, 0, thickness, height), new block(0, -thickness, width, thickness), new block(width, 0, thickness, height));
            var level10blocks = new Array(new block(0, height - thickness, width, thickness), new block(-thickness, 0, thickness, height), new block(0, -thickness, width, thickness), new block(width, 0, thickness, height));
            var levels = new Array(level1blocks, level2blocks, level3blocks, level4blocks, level5blocks, level6blocks);
            var finishes = new Array(new block(width * (25 / 600), height * (1 / 3) - smallest / 12, smallest / 12, smallest / 12), new block(width / 2, height / 6 - smallest / 12, smallest / 12, smallest / 12), new block(width * (32 / 60), height - thickness - smallest / 12, smallest / 12, smallest / 12), new block(width / 20 + thickness, height / 3, smallest / 12, smallest / 12), new block(width * (32 / 60), height - thickness - smallest / 12, smallest / 12, smallest / 12), new block(width / 12, height / 3, smallest / 12, smallest / 12));

            var frameRate = 1000 / 60;
            var engine = new gameEngine();
            var timer;

            var level = 0;
            var playerX = width / 12;
            var radius = smallest * (1 / 24);
            var playerY = height * 11 / 12 - thickness - radius;
            var ground = false;
            var vVel = 0;
            var hVel = 0;
            var blockOn = 0;
            var gameOver = false;
            var watch;
            var accX;

            var restart = document.getElementById("restart");

            var fontSize = parseInt((width + height) / 2 * (2 / 60));
            ctx.font = fontSize + "pt Times New Roman";

            var hammertouch = Hammer(canvas).on("touch", function(event) {
                x = event.gesture.center.pageX;
                y = event.gesture.center.pageY;
                if (x - xOffset < smallest / 8 && x > 0 && y > 0 && y < smallest / 8) {
                    playerX = width / 12;
                    playerY = height - thickness - radius;
                    hVel = 0;
                    vVel = 0;
                    blockOn = 0;
                    ground = true;
                }
                else if (ground === true) {
                    ground = false;
                    vVel = -height / 60;
                    boing.play();
                }
            });

            function gameEngine() {
                this.draw = function() {
                    var blocks = levels[level];
                    ctx.clearRect(0, 0, width, height);
                    ctx.fillStyle = "Blue";
                    ctx.fillRect(0, 0, width, height);
                    ctx.fillStyle = "Green";
                    for (i = 0; i < blocks.length; i++) {
                        ctx.fillRect(blocks[i].x, blocks[i].y, blocks[i].width, blocks[i].height);
                    }
                    ctx.fillStyle = "Red";
                    ctx.fillRect(finishes[level].x, finishes[level].y, finishes[level].width, finishes[level].height);
                    ctx.beginPath();
                    ctx.arc(playerX, playerY, radius, 0, 2 * Math.PI, false);
                    ctx.fill();
                    ctx.fillText("Level: " + (level + 1), width * (2 / 3), height / 12);
                    ctx.drawImage(restart, 0, 0, smallest / 8, smallest / 8);
                };

                this.calculatePos = function() {
                    if (ground) {
                        hVel -= 50* accX / width;                   
                        var collision = engine.collision(playerX + hVel, playerY);
                        if (collision === -1) {
                            playerX += hVel;
                        }
                        else {
                            if (hVel > 0) {
                                playerX = levels[level][collision].x - radius;
                                hVel = 0;
                            }
                            else {
                                playerX = levels[level][collision].x + levels[level][collision].width + radius;
                                hVel = 0;
                            }
                        }
                        var onBlock = levels[level][blockOn];
                        if (playerX + radius < onBlock.x || playerX - radius > onBlock.x + onBlock.width) {
                            ground = false;
                        }
                    }
                    else {
                        vVel += height / 3000;
                        var collision = engine.collision(playerX + hVel, playerY + vVel);
                        if (collision === -1) {
                            playerX += hVel;
                            playerY += vVel;
                        }
                        else {
                            if ((playerY + vVel - radius) < levels[level][collision].y + levels[level][collision].height && (playerY + vVel - radius) > levels[level][collision].y + levels[level][collision].height - 20) {
                                vVel = 0;
                                playerY = levels[level][collision].y + levels[level][collision].height + radius;
                            }
                            else if ((playerY + vVel + radius) < levels[level][collision].y + 20 && (playerY + vVel + radius) > levels[level][collision].y) {
                                vVel = 0;
                                playerY = levels[level][collision].y - radius;
                                ground = true;
                                blockOn = collision;
                            }
                            else if ((playerX + hVel + radius) < levels[level][collision].x + 20 && (playerX + hVel + radius) > levels[level][collision].x) {
                                hVel = 0;
                                playerX = levels[level][collision].x - radius;
                            }
                            else if ((playerX + hVel - radius) < levels[level][collision].x + levels[level][collision].width && (playerX + hVel - radius) > levels[level][collision].x + levels[level][collision].width - 20) {
                                hVel = 0;
                                playerX = levels[level][collision].x + levels[level][collision].width + radius;
                            }
                        }
                    }
                };

                this.collision = function(x, y) {
                    var blocks = levels[level];
                    var collision = -1;
                    for (i = 0; i < blocks.length; i++) {
                        if ((blocks[i].x + blocks[i].width) > (x - radius) && blocks[i].x < (x + radius) && (blocks[i].y + blocks[i].height) > (y - radius) && blocks[i].y < (y + radius)) {
                            collision = i;
                        }
                    }
                    return collision;
                };

                this.atFinish = function() {
                    if (playerX - radius >= finishes[level].x - 5 && playerX + radius <= finishes[level].x + 5 + finishes[level].width && playerY + radius <= finishes[level].y + finishes[level].height + 5 && playerY - radius >= finishes[level].y - 5) {
                        if (level < levels.length - 1) {
                            level++;
                            playerX = width / 12;
                            playerY = height - thickness - radius;
                            hVel = 0;
                            vVel = 0;
                            blockOn = 0;
                            ground = true;
                        }
                        else {
                            gameOver = true;
                            win();
                        }
                    }
                };
            }

            function block(x, y, width, height) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
            }

            function play() {
                engine.calculatePos();
                engine.draw();
                engine.atFinish();
                if (!gameOver) {
                    setTimeout(play, frameRate);
                }
            }

            function win() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = "Blue";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = "Red";
                ctx.fillText("You win!", width / 2, height / 2);
            }

            function accSuccess(acceleration) {
               accX = acceleration.x;
            }

            function accError() {
              alert("ERROR!!?!?");
            }


        </script>
    </body>
</html>

